<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FX Dashboard</title>
  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: #fff;
      color: #111;
      margin: 0;
      padding: 20px;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 0.5rem;
    }
    .panel {
      background: #f8f8f8;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    label {
      display: inline-block;
      margin-right: 12px;
    }
    select {
      padding: 6px 10px;
      font-size: 14px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: right;
    }
    th:first-child, td:first-child { text-align: left; }
    th { background: #f0f0f0; }
    .info { font-size: 14px; margin-top: 8px; color: #555; }

        #combinedHolidays {
      max-width: 500px;
      margin-top: 10px;
    }

    #combinedHolidays table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    #combinedHolidays th,
    #combinedHolidays td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: left;
      word-wrap: break-word;
    }

    #combinedHolidays th {
      background: #f0f0f0;
    }

    #combinedHolidays td:nth-child(1) { width: 30%; }
    #combinedHolidays td:nth-child(2) { width: 20%; }
    #combinedHolidays td:nth-child(3) { width: 50%; }
    
    /* Compact layout for upcoming events */
    #upcomingEvents {
      max-width: 800px;          /* keeps it narrower than full width */
      margin-top: 10px;
      overflow-x: auto;           /* adds horizontal scroll on smaller screens */
    }

    #upcomingEvents table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      table-layout: fixed;        /* prevents columns from expanding too wide */
    }

    #upcomingEvents th,
    #upcomingEvents td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: left;
      word-wrap: break-word;
      white-space: normal;
    }

    #upcomingEvents th {
      background: #f0f0f0;
    }

    #upcomingEvents td:nth-child(1) { width: 22%; } /* Date & Time */
    #upcomingEvents td:nth-child(2) { width: 10%; } /* Currency */
    #upcomingEvents td:nth-child(3) { width: 10%; } /* Importance */
    #upcomingEvents td:nth-child(4) { width: 28%; } /* Event */
    #upcomingEvents td:nth-child(5),
    #upcomingEvents td:nth-child(6),
    #upcomingEvents td:nth-child(7) { width: 10%; } /* Actual / Forecast / Previous */

  </style>
</head>
<body>
  <h1>FX Dashboard – EUR/USD</h1>

  <div class="panel">
    <label>Margin (%): 
      <select id="margin"></select>
    </label>
    <label>Volume: 
      <select id="volume"></select>
    </label>
    <div class="info">
      <strong>Market Rate:</strong> <span id="marketRate">Loading...</span><br/>
      <strong>We can offer EUR > USD at:</strong> <span id="offerRate">–</span><br/>
      <strong>We can offer USD > EUR at:</strong> <span id="inverseRate">–</span><br/>
      <strong>Rate value at:</strong> <span id="lastUpdate">–</span>
    </div>
  </div>

  <h2>Next 5 Settlement Holidays (EUR or USD)</h2>
  <div id="combinedHolidays"></div>

  <h2>Upcoming Economic Events</h2>
  <div id="upcomingEvents"></div>

<script>
  // === CONFIG ===
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_1Df4oUf4sjTdt75U-dcQ5GiMKPmKs1GAOke-rfIck4dwoAS8jua_vjvlMhOou4Huyjd5o2B3FSlB/pub?gid=0&single=true&output=csv";
  const EVENTS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_1Df4oUf4sjTdt75U-dcQ5GiMKPmKs1GAOke-rfIck4dwoAS8jua_vjvlMhOou4Huyjd5o2B3FSlB/pub?gid=433576226&single=true&output=csv";
  const BASE = "EUR", QUOTE = "USD";

  // === DROPDOWNS ===
  const marginSelect = document.getElementById("margin");
  const volumeSelect = document.getElementById("volume");
  for (let i = 0.15; i <= 3.0; i += 0.05) {
    const opt = document.createElement("option");
    opt.value = i / 100;
    opt.textContent = i.toFixed(2) + "%";
    marginSelect.appendChild(opt);
  }
  for (let v = 10000; v <= 100000; v += 10000) {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v.toLocaleString();
    volumeSelect.appendChild(opt);
  }

  // === FETCH CSV ===
  async function fetchCSV(url) {
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("Failed to fetch CSV: " + res.status);
    return await res.text();
  }

  // === PARSE CSV (rates + EUR & USD holiday tables) ===
  function parseCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    const header = lines.shift().split(",").map(h => h.trim().toLowerCase());
    const idx = {
      base: header.indexOf("base"),
      quote: header.indexOf("quote"),
      rate: header.indexOf("rate"),
      time: header.indexOf("time_of_rate"),
      year_eur: header.indexOf("year_eur"),
      month_eur: header.indexOf("month_eur"),
      day_eur: header.indexOf("day_eur"),
      name_eur: header.indexOf("name_eur"),
      year_usd: header.indexOf("year_usd"),
      month_usd: header.indexOf("month_usd"),
      day_usd: header.indexOf("day_usd"),
      name_usd: header.indexOf("name_usd")
    };

    const rates = [];
    const eurHolidays = [];
    const usdHolidays = [];

    for (const line of lines) {
      const cols = line.split(",").map(c => c.replace(/^"|"$/g, '').trim());

      // Rate rows
      if (idx.base >= 0 && idx.quote >= 0 && idx.rate >= 0 &&
          cols[idx.base] && cols[idx.quote] && Number.isFinite(parseFloat(cols[idx.rate]))) {
        rates.push({
          base: cols[idx.base],
          quote: cols[idx.quote],
          rate: parseFloat(cols[idx.rate]),
          time: idx.time >= 0 ? cols[idx.time] : null
        });
      }

      // EUR holidays
      if (idx.year_eur >= 0 && idx.month_eur >= 0 && idx.day_eur >= 0 &&
          cols[idx.year_eur] && cols[idx.month_eur] && cols[idx.day_eur]) {
        eurHolidays.push({
          year: cols[idx.year_eur],
          month: cols[idx.month_eur],
          day: cols[idx.day_eur],
          name: cols[idx.name_eur] || "Holiday",
          region: "EUR"
        });
      }

      // USD holidays
      if (idx.year_usd >= 0 && idx.month_usd >= 0 && idx.day_usd >= 0 &&
          cols[idx.year_usd] && cols[idx.month_usd] && cols[idx.day_usd]) {
        usdHolidays.push({
          year: cols[idx.year_usd],
          month: cols[idx.month_usd],
          day: cols[idx.day_usd],
          name: cols[idx.name_usd] || "Holiday",
          region: "USD"
        });
      }
    }

    return { rates, eurHolidays, usdHolidays };
  }
    // === PARSE EVENTS CSV ===
  function parseEventsCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    const header = lines.shift().split(",").map(h => h.trim().toLowerCase());
    const idx = {
      datetime: header.indexOf("date_and_time"),
      currency: header.indexOf("currency"),
      importance: header.indexOf("importance"),
      event: header.indexOf("event"),
      actual: header.indexOf("actual"),
      forecast: header.indexOf("forecast"),
      previous: header.indexOf("previous")
    };

    const events = [];

    for (const line of lines) {
      const cols = line.split(",").map(c => c.replace(/^"|"$/g, '').trim());
      if (cols[idx.datetime] && cols[idx.currency]) {
        events.push({
          datetime: new Date(cols[idx.datetime]),
          currency: cols[idx.currency],
          importance: cols[idx.importance] || "",
          event: cols[idx.event] || "",
          actual: cols[idx.actual] || "",
          forecast: cols[idx.forecast] || "",
          previous: cols[idx.previous] || ""
        });
      }
    }
    // sort by upcoming
    return events.sort((a, b) => a.datetime - b.datetime);
  }

  // === UTIL: Convert "DD-MMM-YYYY" parts to JS Date ===
  function toDate(day, monAbbr, year) {
    const months = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
    const m = months.indexOf(String(monAbbr).toUpperCase());
    // month is 0-based; coerce to ISO "YYYY-M-D" to avoid locale ambiguity
    return new Date(`${year}-${m+1}-${day}`);
  }

  // === Build combined next 5 holidays across EUR + USD ===
  function getCombinedNextHolidays(eurList, usdList, refDate, count = 5) {
    const all = [...eurList, ...usdList].map(h => ({
      ...h,
      jsDate: toDate(h.day, h.month, h.year)
    }));
    // Only in the future (strictly after refDate), sorted ascending
    const future = all.filter(h => h.jsDate > refDate)
                      .sort((a, b) => a.jsDate - b.jsDate);
    return future.slice(0, count);
  }

  // === Render combined table ===
  function renderCombinedTable(id, holidays) {
    const el = document.getElementById(id);
    if (!el) return;

    if (!holidays.length) {
      el.innerHTML = "<p>No upcoming settlement holidays found.</p>";
      return;
    }

    const rows = holidays.map(h => `
      <tr>
        <td>${h.jsDate.toLocaleDateString()}</td>
        <td>${h.region}</td>
        <td>${h.name}</td>
      </tr>
    `).join("");

    el.innerHTML = `
      <table>
        <thead>
          <tr>
            <th style="text-align:left;">Date</th>
            <th style="text-align:left;">Region</th>
            <th style="text-align:left;">Holiday</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  }

    // === Render events table ===
  function renderEventsTable(id, events, limit = 10) {
    const el = document.getElementById(id);
    if (!el) return;

    if (!events.length) {
      el.innerHTML = "<p>No upcoming events found.</p>";
      return;
    }

    const rows = events.slice(0, limit).map(ev => `
      <tr>
        <td>${ev.datetime.toLocaleString()}</td>
        <td>${ev.currency}</td>
        <td>${ev.importance}</td>
        <td>${ev.event}</td>
        <td>${ev.actual}</td>
        <td>${ev.forecast}</td>
        <td>${ev.previous}</td>
      </tr>
    `).join("");

    el.innerHTML = `
      <table style="font-size:13px;">
        <thead>
          <tr>
            <th>Date & Time</th>
            <th>Currency</th>
            <th>Importance</th>
            <th>Event</th>
            <th>Actual</th>
            <th>Forecast</th>
            <th>Previous</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  }

  // === Main ===
  async function main() {
    try {
      const csv = await fetchCSV(CSV_URL);
      const { rates, eurHolidays, usdHolidays } = parseCSV(csv);

      // Rate panel
      const pair = rates.find(r => r.base === BASE && r.quote === QUOTE);
      if (!pair) throw new Error("EUR/USD not found in data");

      const marketRate = pair.rate;
      document.getElementById("marketRate").textContent = marketRate.toFixed(6);
      document.getElementById("lastUpdate").textContent = pair.time || "unknown";

      function recalc() {
        const margin = parseFloat(marginSelect.value) || 0;
        const adjusted = marketRate * (1 - margin);
        const inverse = (1 / marketRate) * (1 - margin);
        document.getElementById("offerRate").textContent = adjusted.toFixed(6);
        document.getElementById("inverseRate").textContent = inverse.toFixed(6);
      }
      marginSelect.addEventListener("change", recalc);
      volumeSelect.addEventListener("change", recalc);
      recalc();

      // Combined holiday table using time_of_rate as reference
      const refDate = new Date(pair.time || Date.now());
      const combinedNext5 = getCombinedNextHolidays(eurHolidays, usdHolidays, refDate, 5);
      renderCombinedTable("combinedHolidays", combinedNext5);

      // === Fetch and render economic events ===
      const eventsCSV = await fetchCSV(EVENTS_CSV_URL);
      const events = parseEventsCSV(eventsCSV);

      // show only upcoming ones (after current time)
      const now = new Date();
      const upcoming = events.filter(e => e.datetime > now);

      renderEventsTable("upcomingEvents", upcoming, 10);


    } catch (e) {
      document.body.innerHTML = `<p style="color:red">${e.message}</p>`;
      console.error(e);
    }
  }

  main();
</script>

</body>
</html>
