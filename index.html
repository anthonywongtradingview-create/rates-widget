<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FX Dashboard</title>
  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: #fff;
      color: #111;
      margin: 0;
      padding: 20px;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 0.5rem;
    }
    .panel {
      background: #f8f8f8;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    label {
      display: inline-block;
      margin-right: 12px;
    }
    select {
      padding: 6px 10px;
      font-size: 14px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: right;
    }
    th:first-child, td:first-child { text-align: left; }
    th { background: #f0f0f0; }
    .info { font-size: 14px; margin-top: 8px; color: #555; }
  </style>
</head>
<body>
  <h1>FX Dashboard – EUR/USD</h1>

  <div class="panel">
    <label>Margin (%): 
      <select id="margin"></select>
    </label>
    <label>Volume: 
      <select id="volume"></select>
    </label>
    <div class="info">
      <strong>Market Rate:</strong> <span id="marketRate">Loading...</span><br/>
      <strong>What we can offer at:</strong> <span id="offerRate">–</span><br/>
      <strong>Inverse (USD→EUR):</strong> <span id="inverseRate">–</span><br/>
      <strong>Last Updated:</strong> <span id="lastUpdate">–</span>
    </div>
  </div>

  <script>
    // === CONFIG ===
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_1Df4oUf4sjTdt75U-dcQ5GiMKPmKs1GAOke-rfIck4dwoAS8jua_vjvlMhOou4Huyjd5o2B3FSlB/pub?gid=0&single=true&output=csv";
    const BASE = "EUR", QUOTE = "USD"; // Which pair to use from your CSV

    // === INITIALIZE DROPDOWNS ===
    const marginSelect = document.getElementById("margin");
    const volumeSelect = document.getElementById("volume");
    for (let i = 0.15; i <= 3.0; i += 0.005) {
      const opt = document.createElement("option");
      opt.value = i / 100;
      opt.textContent = (i).toFixed(3) + "%";
      marginSelect.appendChild(opt);
    }
    for (let v = 10000; v <= 100000; v += 10000) {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v.toLocaleString();
      volumeSelect.appendChild(opt);
    }

    // === FETCH & PARSE CSV ===
    async function fetchCSV(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("Failed to fetch CSV: " + res.status);
      return await res.text();
    }

    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      const header = lines.shift().split(",").map(h => h.trim());
      const idx = {
        Base: header.findIndex(h => h.toLowerCase() === "base"),
        Quote: header.findIndex(h => h.toLowerCase() === "quote"),
        Rate: header.findIndex(h => h.toLowerCase() === "rate"),
      };
      const rows = lines.map(line => {
        const cols = line.split(",").map(c => c.trim());
        return {
          base: cols[idx.Base],
          quote: cols[idx.Quote],
          rate: parseFloat(cols[idx.Rate]),
        };
      });
      return rows.filter(r => r.base && r.quote && Number.isFinite(r.rate));
    }

    // === RENDER DASHBOARD ===
    async function main() {
      try {
        const csv = await fetchCSV(CSV_URL);
        const data = parseCSV(csv);
        const pair = data.find(r => r.base === BASE && r.quote === QUOTE);
        if (!pair) throw new Error("EUR/USD not found in data");

        const marketRate = pair.rate;
        const rateEl = document.getElementById("marketRate");
        const offerEl = document.getElementById("offerRate");
        const invEl = document.getElementById("inverseRate");
        const updateEl = document.getElementById("lastUpdate");

        rateEl.textContent = marketRate.toFixed(6);
        const updateTime = new Date().toLocaleString();
        updateEl.textContent = updateTime;

        function recalc() {
          const margin = parseFloat(marginSelect.value) || 0;
          const adjusted = marketRate * (1 - margin);
          const inverse = (1 / marketRate) * (1 - margin);
          offerEl.textContent = adjusted.toFixed(6);
          invEl.textContent = inverse.toFixed(6);
        }

        marginSelect.addEventListener("change", recalc);
        volumeSelect.addEventListener("change", recalc);
        recalc();

      } catch (e) {
        document.body.innerHTML = `<p style="color:#b00;">${e.message}</p>`;
        console.error(e);
      }
    }

    main();
  </script>
</body>
</html>
